# 四元数

[上篇文章](/14-euler-gimbal.md)介绍了使用欧拉角表示定向，但是欧拉角有个根本性的问题万向节死锁。我们可以使用的四元数来解决这个问题。但是四元数比较复杂，让我们先来看看用轴-角来表示定向。

## 轴-角

根据欧拉旋转定理，任何三维旋转都可以用一个轴（`n`）和对这个轴的旋转角（`θ`）度表示。对于两个定向 R1 和 R2，存在一个轴 `n`，进行一次旋转 `θ`，就可以将 R1 旋转到 R2。欧拉角用三个数字表示对三个基本坐标轴的旋转量。轴-角形式使用 4 个数字，1 个表示旋转角度的标量，3 个数字表示三维坐标轴的矢量。

## 四元数

四元数（Quaternion）使用 4 个数字表示定向，这也是它名字的由来。和上面介绍的轴-角一样，它也是 1 个标量和 1 个矢量组成。标量一般用 `w` 表示，`v` 或 `[x, y, z]` 表示矢量。

```js
[w, v]

[w (x, y, z)]
```

和轴-角形式不同的是，四元数并不是简单的存储旋转轴和旋转角度，它和轴-角的关系如下。

```js
[w v] = [cos(θ / 2) sin(θ / 2) * N]

[w, (x, y, z)] = [cos(θ / 2) (sin(θ / 2) * Nx, sin(θ / 2) * Ny, sin(θ / 2) * Nz)]
```

四元数也可以变负，只要将的 4 个数字都变为负数就行 `[-w (-x, -y, -z)]`，比较有意思的是的正 `Q` 和负 `-Q`四元数表示的是相同的角位移，因为变负意味着沿轴的另一端反方向旋转。

### 单位四元数

单位四元数表示没有旋转，有两个单位四元数，分别是 `[1 (0, 0, 0)]` 和 `[-1 (0, 0, 0)]` ，当 `θ` 是 360 的偶数倍时 `cos(θ / 2) = 1`，当 `θ` 是 360 的奇数倍时 `cos(θ / 2) = -1`。但是在数学上，只有 `[1, (0, 0, 0)]` 一个单位四元数。

### 四元数大小

和矢量一样四元数也有大小并且计算方式也一样。

```js
||Q|| = ||[w (x, y, z)]|| = Math.sqrt(w ** 2, x ** 2, y ** 2, z ** 2)
```

我们只关心旋转量，也就是矢量是单位矢量。

```js
||Q|| = ||[w, v]||
      = Math.sqrt(cos(θ / 2) ** 2 + (sin(θ / 2) * N) ** 2)
      = Math.sqrt(1)
      = 1
```

我们使用四元数的目的是为了表示定向，所以我们这里使用的四元数都是长度为 1 的四元数。

### 共轭和逆

四元数的共轭表示为 $Q^*$ ，它是将矢量部分变负得到的，`[w (-x, -y, -z)]`，四元数和它的共轭表示的是相反的旋转，因为共轭是将矢量变负，也就是将翻转旋转轴，但是旋转方向没变。

四元数的逆表示为 $Q^{-1}$ ，它是四元数的共轭除以四元数的大小得到的。

$$
Q^{-1} = \frac{Q^*}{\parallel Q\parallel}
$$

和标量一样，四元数乘以它的逆等于单位四元数 `[1, (0, 0, 0)]`。之前我们说过我们只关心旋转，所以旋转轴是单位矢量，四元数大小也是 1。所以对于我们来说四元数的逆和共轭是相等的。

### 乘法

四元数和标量相乘，结果是四元数的每个分量都乘以标量。

```js
k * Q = k * [w (x, y, z)]
      = [k * w (k * x, k * y, k * z)]
```

四元数与四元数相乘，其结果还是四元数。

```js
Q1 Q2 = [w1 (x1, y1, z1)] [w2 (x2, y2, z2)]
      = [
        w1 * w2 - x1 * x2 - y1 * y2 - z1 * z2,
        (
          w1 * x2 + x1 * w2 + y1 * z2 - z1 * y2,
          w1 * y2 + y1 * w2 + z1 * x2 - x1 * z2,
          w1 * z2 + z1 * w2 + x1 * y2 - y1 * x2
        )
      ]
      = [w1 v1] [w2 v2]
      = [w1 * w2 - v1 · v2 , w1 * v2 + w2 * v1 + v1 × v2]
```

四元数乘法可以结合但是不可以交换。四元数乘积的大小等于，它们大小的乘积。四元数乘积的倒数等于相反顺序倒数的乘积。

```js
(ab)c = a(bc)

ab != ba

||ab|| = ||a|| * ||b||

(ab) ^ -1 = b ^ -1 * a ^ -1
```



### 差

### 点积

### 

